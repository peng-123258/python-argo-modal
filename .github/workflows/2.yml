name: Deploy 3 Independent Apps

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 3个独立的Python文件，对应不同实例
        app_file:
          - "app_to.py"  # 实例1
          - "app_ysl.py" # 实例2
          - "app_ny.py"  # 实例3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install modal

      - name: Authenticate Modal
        run: modal token set --token-id ${{ secrets.MODAL_TOKEN_ID }} --token-secret ${{ secrets.MODAL_TOKEN_SECRET }}

      - name: Deploy ${{ matrix.app_file }}
        run: |
          # 为每个文件设置独立名称（从文件名提取）
          APP_NAME=$(echo ${{ matrix.app_file }} | sed 's/.py//')
          echo "部署应用: $APP_NAME"
          # 部署对应Python文件
          modal deploy ${{ matrix.app_file }}

      - name: Output URL for ${{ matrix.app_file }}
        run: |
          APP_NAME=$(echo ${{ matrix.app_file }} | sed 's/.py//')
          echo "✅ $APP_NAME 部署完成"
          echo "访问地址: https://${{ secrets.MODAL_USER_NAME }}--${APP_NAME}-web.modal.run"
