name: multi-region-proxy-deploy

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # 每日凌晨更新部署

jobs:
  deploy-multi-instance:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 与代码 INSTANCE_CONFIGS 完全对齐
        instance:
          - { prefix: "TO", default_region: "asia-northeast3" }
          - { prefix: "YSL", default_region: "me-west1" }
          - { prefix: "NY", default_region: "sa-east-1" }

    env:
      # 全局共享配置（对应代码全局变量）
      MODAL_USER_NAME: ${{ secrets.MODAL_USER_NAME }}
      COMMON_UUID: ${{ secrets.COMMON_UUID || 'be16536e-5c3c-44bc-8cb7-b7d0ddc3d951' }}
      COMMON_CFIP: ${{ secrets.COMMON_CFIP || 'www.visa.com.tw' }}
      COMMON_CFPORT: ${{ secrets.COMMON_CFPORT || 443 }}
      SUB_PATH: ${{ secrets.SUB_PATH || 'sub' }}
      # 实例专属前缀（用于环境变量注入）
      INSTANCE_PREFIX: ${{ matrix.instance.prefix }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install modal fastapi requests

      - name: Authenticate Modal
        run: |
          modal token set --token-id ${{ secrets.MODAL_TOKEN_ID }} --token-secret ${{ secrets.MODAL_TOKEN_SECRET }}

      - name: Prepare instance secrets
        run: |
          # 创建实例专属 Secret（名称包含前缀，避免冲突）
          modal secret delete "${INSTANCE_PREFIX}-secrets" --yes || true
          modal secret create "${INSTANCE_PREFIX}-secrets" \
            COMMON_UUID="${COMMON_UUID}" \
            COMMON_CFIP="${COMMON_CFIP}" \
            COMMON_CFPORT="${COMMON_CFPORT}" \
            "${INSTANCE_PREFIX}_ARGO_DOMAIN"="${{ secrets[format('{0}_ARGO_DOMAIN', matrix.instance.prefix)] || '' }}" \
            "${INSTANCE_PREFIX}_ARGO_AUTH"="${{ secrets[format('{0}_ARGO_AUTH', matrix.instance.prefix)] || '' }}" \
            "${INSTANCE_PREFIX}_REGION"="${{ matrix.instance.default_region }}"

      - name: Deploy instance to Modal
        run: |
          # 注入实例专属环境变量（与代码中 os.environ.get 对应）
          export "${INSTANCE_PREFIX}_APP_NAME"="proxy-node-${INSTANCE_PREFIX,,}"  # 小写前缀，如 TO → proxy-node-to
          export "${INSTANCE_PREFIX}_REGION"="${{ matrix.instance.default_region }}"
          export MODAL_USER_NAME="${MODAL_USER_NAME}"
          export SUB_PATH="${SUB_PATH}"
          
          # 部署（应用名由代码内部定义，无需--name参数）
          modal deploy modal_app.py  # 假设代码文件名为 modal_app.py

      - name: Output deployment info
        run: |
          APP_NAME="proxy-node-${INSTANCE_PREFIX,,}"
          echo "✅ 实例部署完成: ${APP_NAME}"
          echo "地区: ${{ matrix.instance.default_region }}"
          echo "订阅地址: https://${MODAL_USER_NAME}--${APP_NAME}-web_server.modal.run/${SUB_PATH}"
